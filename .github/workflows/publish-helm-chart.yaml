name: Publish keda-kaito-scaler helm chart

on:
  repository_dispatch:
    types: [ publish-scaler-helm-chart ]

permissions:
  id-token: write # This is required for requesting the JWT
  packages: write
  contents: write
  actions: read
  deployments: read
  pull-requests: read

jobs:
  publish-scaler-helm:
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@ec9f2d5744a09debf3a187a3f4f675c53b671911 # v2.13.0
        with:
          egress-policy: audit
          disable-sudo: true
          disable-telemetry: true

      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          submodules: true
          fetch-depth: 0
          ref: ${{ github.event.client_payload.tag }}

      - name: Configure Git
        run: |
          git config user.name "kaito-dev"
          git config user.email "kaito-dev@microsoft.com"

      - name: Create gh-pages branch if it doesn't exist
        run: |
          # Check if gh-pages branch exists on remote
          if ! git ls-remote --heads origin gh-pages | grep -q gh-pages; then
            echo "Creating gh-pages branch..."
            git checkout --orphan gh-pages
            git rm -rf .
            echo "# Helm Charts Repository" > README.md
            git add README.md
            git commit -m "Initialize gh-pages branch for Helm charts"
            git push origin gh-pages
            # Switch back to the original ref
            git checkout ${{ github.event.client_payload.tag }}
          else
            echo "gh-pages branch already exists"
          fi

      - name: Publish scaler helm chart
        uses: helm/chart-releaser-action@v1.7.0
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
